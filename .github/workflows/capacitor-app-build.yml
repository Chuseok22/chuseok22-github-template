name: Capacitor App Build

on:
  repository_dispatch:
    types:
      - version-bumped

  workflow_dispatch:
    inputs:
      tag:
        description: 'ë¹Œë“œí•  íƒœê·¸ (ì˜ˆ: v1.2.3)'
        required: true
        type: string

permissions:
  contents: write
  actions: read

env:
  APP_NAME: 'AppName'
  NODE_VERSION: '22'
  JAVA_VERSION: '21'

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 1: ë²„ì „ ê²€ì¦
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  check-version-update:
    name: ðŸ” ë²„ì „ ì—…ë°ì´íŠ¸ í™•ì¸
    runs-on: ubuntu-latest

    outputs:
      should-build: ${{ steps.check-update.outputs.should-build }}
      tag: ${{ steps.check-update.outputs.tag }}
      version: ${{ steps.check-update.outputs.version }}
      version_code: ${{ steps.check-update.outputs.version_code }}

    steps:
      - name: ðŸ›Žï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Check if version was actually updated
        id: check-update
        run: |
          set -Eeuo pipefail

          SEMVER_TAG_REGEX='^v(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)$' # vX.Y.Z
          SEMVER_VER_REGEX='^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)$' # X.Y.Z
          
          SHOULD_BUILD="false"
          TAG=""
          VERSION=""
          VERSION_CODE=""

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # ìˆ˜ë™ ì‹¤í–‰ì¸ ê²½ìš°
            TAG="${{ github.event.inputs.tag }}"
            # íƒœê·¸ í˜•ì‹ ê²€ì¦
            if [[ ! $TAG =~ $SEMVER_TAG_REGEX ]]; then
              echo "âŒ ìž˜ëª»ëœ íƒœê·¸ í˜•ì‹: $TAG (v1.2.3 í˜•ì‹ì´ì–´ì•¼ í•¨)"
              exit 1
            fi
            VERSION="${TAG#v}"
            SHOULD_BUILD="true"
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "âœ… ìˆ˜ë™ ì‹¤í–‰: $TAG"
          else
            RAW_TAG="${{ github.event.client_payload.new_tag }}"
            RAW_VER="${{ github.event.client_payload.new_version }}"

            if [ -n "$RAW_TAG" ] && [[ "$RAW_TAG" =~ $SEMVER_TAG_REGEX ]]; then
              TAG="$RAW_TAG"
              VERSION="${RAW_TAG#v}"
              SHOULD_BUILD="true"
              echo "should-build=true"  >> "$GITHUB_OUTPUT"
              echo "tag=$RAW_TAG"       >> "$GITHUB_OUTPUT"
              echo "version=$VERSION"   >> "$GITHUB_OUTPUT"
              echo "âœ… repository_dispatch tag: $RAW_TAG"
            elif [ -n "$RAW_VER" ] && [[ "$RAW_VER" =~ $SEMVER_VER_REGEX ]]; then
              TAG="$RAW_TAG"
              VERSION="${RAW_TAG#v}"
              SHOULD_BUILD="true"
              echo "should-build=true"  >> "$GITHUB_OUTPUT"
              echo "tag=v$RAW_VER"      >> "$GITHUB_OUTPUT"
              echo "version=$RAW_VER"   >> "$GITHUB_OUTPUT"
              echo "âœ… repository_dispatch version: $RAW_VER"
            else
              echo "should-build=false" >> "$GITHUB_OUTPUT"
              echo "ðŸ“ repository_dispatch payloadì— ìœ íš¨í•œ tag/versionì´ ì—†ìŠµë‹ˆë‹¤. ë¹Œë“œ ìƒëžµ"
            fi
          fi
          
          echo "should-build=$SHOULD_BUILD" >> "$GITHUB_OUTPUT"

          if [ "$SHOULD_BUILD" = "true" ]; then
            # VERSION_CODE ìƒì„± (v0.1.15 -> 000115 -> 115)
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

            # ê° íŒŒíŠ¸ 0~99 ì œí•œ (2ìžë¦¬ ìŠ¤í‚¤ë§ˆ ê³ ì •)
            if [ "$MAJOR" -gt 99 ] || [ "$MINOR" -gt 99 ] || [ "$PATCH" -gt 99 ]; then
              echo "âŒ VERSION_CODE ìƒì„± ì‹¤íŒ¨: major/minor/patchëŠ” 0~99 ë²”ìœ„ì—¬ì•¼ í•¨ (í˜„ìž¬: $VERSION)"
              exit 1
            fi

            PADDED="$(printf "%02d%02d%02d" "$MAJOR" "$MINOR" "$PATCH")"
            VERSION_CODE="$(echo "$PADDED" | sed 's/^0*//')"
            if [ -z "$VERSION_CODE" ]; then
              VERSION_CODE="1"
            fi

            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "version_code=$VERSION_CODE" >> "$GITHUB_OUTPUT"

            echo "âœ… TAG=$TAG"
            echo "âœ… VERSION=$VERSION"
            echo "âœ… VERSION_CODE=$VERSION_CODE (from $PADDED)"
          fi

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 2: Next.js ë¹Œë“œ
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  build-web:
    name: ðŸŒ Build Next.js
    runs-on: ubuntu-latest
    needs: check-version-update
    if: needs.check-version-update.outputs.should-build == 'true'

    steps:
      - name: ðŸ›Žï¸ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-version-update.outputs.tag }}

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build Next.js
        run: npm run build

      - name: ðŸ“¤ Upload web build
        uses: actions/upload-artifact@v4
        with:
          name: web-build-${{ needs.check-version-update.outputs.version }}
          path: out/
          retention-days: 1

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 3: Android ë¹Œë“œ
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  build-android:
    name: ðŸ¤– Build Android
    runs-on: ubuntu-latest
    needs: [ check-version-update, build-web ]
    if: needs.check-version-update.outputs.should-build == 'true'

    steps:
      - name: ðŸ›Žï¸ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-version-update.outputs.tag }}

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: â˜• Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ðŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ“¥ Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-build-${{ needs.check-version-update.outputs.version }}
          path: out/

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”„ Capacitor sync
        run: npx cap sync android

      - name: ðŸ” Setup Android signing
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "âŒ ANDROID_KEYSTORE_BASE64 secret not found"
            exit 1
          fi

          KEYSTORE_PATH="$RUNNER_TEMP/release.keystore"
          echo "$KEYSTORE_BASE64" | base64 -d > "$KEYSTORE_PATH"
          echo "KEYSTORE_PATH=$KEYSTORE_PATH" >> $GITHUB_ENV
          echo "âœ… Keystore created"

      - name: ðŸ—ï¸ Build APK
        env:
          VERSION_NAME: ${{ needs.check-version-update.outputs.version }}
          VERSION_CODE: ${{ needs.check-version-update.outputs.version_code }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file="$KEYSTORE_PATH" \
            -Pandroid.injected.signing.store.password="$KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD"

      - name: ðŸ—ï¸ Build AAB
        env:
          VERSION_NAME: ${{ needs.check-version-update.outputs.version }}
          VERSION_CODE: ${{ needs.check-version-update.outputs.version_code }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cd android
          ./gradlew bundleRelease \
            -Pandroid.injected.signing.store.file="$KEYSTORE_PATH" \
            -Pandroid.injected.signing.store.password="$KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD"

      - name: ðŸ“¦ Rename outputs
        id: rename
        env:
          VERSION: ${{ needs.check-version-update.outputs.version }}
        run: |
          APK_SRC=$(find android/app/build/outputs/apk/release -name "*.apk" -type f | head -n1)
          AAB_SRC=$(find android/app/build/outputs/bundle/release -name "*.aab" -type f | head -n1)

          if [ -z "$APK_SRC" ]; then
            echo "âŒ APK not found"
            exit 1
          fi
          if [ -z "$AAB_SRC" ]; then
            echo "âŒ AAB not found"
            exit 1
          fi

          APK_DEST="${{ env.APP_NAME }}-${VERSION}.apk"
          AAB_DEST="${{ env.APP_NAME }}-${VERSION}.aab"

          cp "$APK_SRC" "$APK_DEST"
          cp "$AAB_SRC" "$AAB_DEST"

          echo "apk=$APK_DEST" >> $GITHUB_OUTPUT
          echo "aab=$AAB_DEST" >> $GITHUB_OUTPUT
          echo "âœ… APK: $APK_DEST"
          echo "âœ… AAB: $AAB_DEST"

      - name: ðŸ“Ž Upload to Release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ needs.check-version-update.outputs.tag }}
        run: |
          gh release upload "$TAG" \
            "${{ steps.rename.outputs.apk }}" \
            "${{ steps.rename.outputs.aab }}" \
            --clobber

      - name: ðŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ needs.check-version-update.outputs.version }}
          path: |
            ${{ steps.rename.outputs.apk }}
            ${{ steps.rename.outputs.aab }}
          retention-days: 90

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 4: iOS ë¹Œë“œ
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  build-ios:
    name: ðŸŽ Build iOS
    runs-on: macos-15
    needs: [ check-version-update, build-web ]
    if: needs.check-version-update.outputs.should-build == 'true'

    env:
      XCODE_VERSION: "26.2"

    steps:
      - name: ðŸ›Žï¸ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-version-update.outputs.tag }}

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ Select Xcode Version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: âœ… Verify Xcode + SDKs
        shell: bash
        run: |
          set -euo pipefail
          
          xcodebuild -version
          xcodebuild -showsdks
          
          # âœ… (ì¶”ê°€) iOS 26 SDK ì¡´ìž¬ ì—¬ë¶€ ê°•ì œ ê²€ì¦
          if ! xcodebuild -showsdks | grep -q "iphoneos26"; then
            echo "âŒ iOS 26 SDK not found on this runner."
            echo "Installed Xcode apps:"
            ls -d /Applications/Xcode*.app 2>/dev/null || true
            exit 1
          fi
          
          echo "âœ… iOS 26 SDK detected."

      - name: ðŸ“¥ Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-build-${{ needs.check-version-update.outputs.version }}
          path: out/

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”„ Capacitor sync
        run: npx cap sync ios

      - name: ðŸ“ Update iOS version
        env:
          VERSION: ${{ needs.check-version-update.outputs.version }}
          BUILD_NUMBER: ${{ github.run_number }}
        run: |
          PLIST="ios/App/App/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" "$PLIST"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" "$PLIST"

      - name: ðŸ” Setup iOS signing
        env:
          P12_BASE64: ${{ secrets.IOS_CERT_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
          PROVISION_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          # Create keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          CERT_PATH="$RUNNER_TEMP/cert.p12"
          echo "$P12_BASE64" | base64 -d > "$CERT_PATH"
          security import "$CERT_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$P12_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security \
            -T /usr/bin/xcodebuild

          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_PATH"

          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # Install provisioning profile
          PROVISION_PATH="$RUNNER_TEMP/profile.mobileprovision"
          echo "$PROVISION_BASE64" | base64 -d > "$PROVISION_PATH"

          PROFILE_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROFILE_DIR"

          # Extract both UUID (for file naming) and Name (for xcodebuild)
          UUID=$(security cms -D -i "$PROVISION_PATH" | plutil -extract UUID raw -)
          PROFILE_NAME=$(security cms -D -i "$PROVISION_PATH" | plutil -extract Name raw -)

          cp "$PROVISION_PATH" "$PROFILE_DIR/$UUID.mobileprovision"

          # Export profile name for xcodebuild (recommended method since Xcode 8)
          echo "PROVISIONING_PROFILE_NAME=$PROFILE_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "âœ… Signing configured"
          echo "   Profile Name: $PROFILE_NAME"
          echo "   UUID: $UUID"

      - name: âœ… Validate Xcode project & scheme
        run: |
          set -Eeuo pipefail
          if [ ! -d "ios/App/App.xcodeproj" ]; then
            echo "âŒ ios/App/App.xcodeproj not found"
            ls -la ios/App || true
            exit 1
          fi
          xcodebuild -list -project ios/App/App.xcodeproj

      - name: ðŸ§© Resolve SPM dependencies (separate step)
        run: |
          set -Eeuo pipefail
          xcodebuild -resolvePackageDependencies \
            -project ios/App/App.xcodeproj \
            -scheme App

      - name: ðŸ—ï¸ Build iOS archive
        env:
          TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
        run: |
          set -Eeuo pipefail

          ARCHIVE_PATH="$RUNNER_TEMP/App.xcarchive"
          RESULT_PATH="$RUNNER_TEMP/archive.xcresult"
          DERIVED_DATA_PATH="$RUNNER_TEMP/DerivedData"

          rm -rf "$ARCHIVE_PATH" "$RESULT_PATH" "$DERIVED_DATA_PATH" || true

          # xcodebuild ë¡œê·¸ë¥¼ íŒŒì¼ë¡œë„ ë‚¨ê¹€ (ì¶”í›„ ë””ë²„ê·¸ìš©)
          LOG_PATH="$RUNNER_TEMP/xcodebuild-archive.log"
          echo "LOG_PATH=$LOG_PATH" >> $GITHUB_ENV

          xcodebuild archive \
            -project ios/App/App.xcodeproj \
            -scheme App \
            -configuration Release \
            -archivePath "$ARCHIVE_PATH" \
            -destination 'generic/platform=iOS' \
            -derivedDataPath "$DERIVED_DATA_PATH" \
            -resultBundlePath "$RESULT_PATH" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="$PROVISIONING_PROFILE_NAME" \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            2>&1 | tee "$LOG_PATH"

          # âœ… ì‹¤ì œ ìƒì„±ëœ archive ê²½ë¡œë¥¼ ë™ì ìœ¼ë¡œ ì°¾ê³  ê²€ì¦
          FOUND_ARCHIVE_PATH=$(find "$RUNNER_TEMP" -maxdepth 2 -name "*.xcarchive" -type d | head -n 1 || true)
          if [ -z "$FOUND_ARCHIVE_PATH" ]; then
            echo "âŒ No .xcarchive found under RUNNER_TEMP=$RUNNER_TEMP"
            echo "---- RUNNER_TEMP list ----"
            ls -la "$RUNNER_TEMP" || true
            exit 1
          fi

          echo "ARCHIVE_PATH=$FOUND_ARCHIVE_PATH" >> $GITHUB_ENV
          echo "âœ… Archive created: $FOUND_ARCHIVE_PATH"

      - name: ðŸ“¦ Export IPA
        env:
          TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
          BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
        run: |
          cat > "$RUNNER_TEMP/ExportOptions.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>$TEAM_ID</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>$BUNDLE_ID</key>
              <string>$PROVISIONING_PROFILE_NAME</string>
            </dict>
            <key>signingCertificate</key>
            <string>Apple Distribution</string>
            <key>signingStyle</key>
            <string>manual</string>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$RUNNER_TEMP/export" \
            -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist"

      - name: ðŸ“¦ Rename IPA
        id: rename
        env:
          VERSION: ${{ needs.check-version-update.outputs.version }}
        run: |
          IPA_SRC="$RUNNER_TEMP/export/App.ipa"
          IPA_DEST="${{ env.APP_NAME }}-${VERSION}.ipa"

          if [ ! -f "$IPA_SRC" ]; then
            echo "âŒ IPA not found at $IPA_SRC"
            ls -la "$RUNNER_TEMP/export/" || true
            exit 1
          fi

          cp "$IPA_SRC" "$IPA_DEST"
          echo "ipa=$IPA_DEST" >> $GITHUB_OUTPUT
          echo "âœ… IPA: $IPA_DEST"

      - name: ðŸ“Ž Upload to Release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ needs.check-version-update.outputs.tag }}
        run: |
          gh release upload "$TAG" \
            "${{ steps.rename.outputs.ipa }}" \
            --clobber

      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ needs.check-version-update.outputs.version }}
          path: ${{ steps.rename.outputs.ipa }}

  trigger-upload:
    name: Capacitor App ìžë™ ì—…ë¡œë“œ íŠ¸ë¦¬ê±° (repository_dispatch)
    runs-on: ubuntu-latest
    needs: [ check-version-update, build-android, build-ios ]
    if: needs.check-version-update.outputs.should-build == 'true'

    steps:
      - name: ðŸš€ Dispatch upload workflow
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ needs.check-version-update.outputs.tag }}
          VERSION: ${{ needs.check-version-update.outputs.version }}
        run: |
          set -Eeuo pipefail

          if [ -z "$TAG" ] || [ -z "$VERSION" ]; then
            echo "âŒ TAG/VERSION missing (TAG=$TAG, VERSION=$VERSION)"
            exit 1
          fi

          cat > payload.json <<EOF
          {
            "event_type": "capacitor-upload",
            "client_payload": {
              "tag": "${TAG}",
              "version": "${VERSION}",
              "sha": "${{ github.sha }}",
              "run_id": "${{ github.run_id }}"
            }
          }
          EOF

          curl --fail --show-error -sS -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/dispatches" \
            --data-binary @payload.json

          echo "âœ… Dispatched capacitor-upload for $TAG ($VERSION)"
