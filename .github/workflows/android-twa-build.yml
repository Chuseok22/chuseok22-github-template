name: Android TWA Build

on:
  repository_dispatch:
    types:
      - version-bumped

  workflow_dispatch:
    inputs:
      tag:
        description: 'ë¹Œë“œí•  íƒœê·¸ (ì˜ˆ: v1.0.0)'
        required: true
        type: string

concurrency:
  group: android-twa-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '21'
  ANDROID_API_LEVEL: '36'
  ANDROID_BUILD_TOOLS: '36.0.0'
  APP_NAME: 'ExampleApp'
  WEBSITE_URL: 'https://www.example.com'
  PACKAGE_ID: 'com.example.app'

permissions:
  contents: write
  actions: read

jobs:
  check-version-update:
    name: ğŸ” ë²„ì „ ì—…ë°ì´íŠ¸ í™•ì¸
    runs-on: ubuntu-latest

    outputs:
      should-build: ${{ steps.check-update.outputs.should-build }}
      tag: ${{ steps.check-update.outputs.tag }}
      version: ${{ steps.check-update.outputs.version }}

    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      - name: ğŸ” Check if version was actually updated
        id: check-update
        run: |
          set -Eeuo pipefail

          SEMVER_TAG_REGEX='^v(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)$' # vX.Y.Z
          SEMVER_VER_REGEX='^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)$' # X.Y.Z

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # ìˆ˜ë™ ì‹¤í–‰ì¸ ê²½ìš°
            TAG="${{ github.event.inputs.tag }}"
            # íƒœê·¸ í˜•ì‹ ê²€ì¦
            if [[ ! $TAG =~ $SEMVER_TAG_REGEX ]]; then
              echo "âŒ ì˜ëª»ëœ íƒœê·¸ í˜•ì‹: $TAG (v1.2.3 í˜•ì‹ì´ì–´ì•¼ í•¨)"
              exit 1
            fi
            VERSION="${TAG#v}"
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "âœ… ìˆ˜ë™ ì‹¤í–‰: $TAG"
          else
            RAW_TAG="${{ github.event.client_payload.new_tag }}"
            RAW_VER="${{ github.event.client_payload.new_version }}"

            if [ -n "$RAW_TAG" ] && [[ "$RAW_TAG" =~ $SEMVER_TAG_REGEX ]]; then
              VERSION="${RAW_TAG#v}"
              echo "should-build=true"  >> "$GITHUB_OUTPUT"
              echo "tag=$RAW_TAG"       >> "$GITHUB_OUTPUT"
              echo "version=$VERSION"   >> "$GITHUB_OUTPUT"
              echo "âœ… repository_dispatch tag: $RAW_TAG"
            elif [ -n "$RAW_VER" ] && [[ "$RAW_VER" =~ $SEMVER_VER_REGEX ]]; then
              echo "should-build=true"  >> "$GITHUB_OUTPUT"
              echo "tag=v$RAW_VER"      >> "$GITHUB_OUTPUT"
              echo "version=$RAW_VER"   >> "$GITHUB_OUTPUT"
              echo "âœ… repository_dispatch version: $RAW_VER"
            else
              echo "should-build=false" >> "$GITHUB_OUTPUT"
              echo "ğŸ“ repository_dispatch payloadì— ìœ íš¨í•œ tag/versionì´ ì—†ìŠµë‹ˆë‹¤. ë¹Œë“œ ìƒëµ"
            fi
          fi

  # ğŸš€ ì‹¤ì œ APK & AAB ë¹Œë“œ (ìƒˆ ë²„ì „ì´ ìˆì„ ë•Œë§Œ)
  build-app:
    name: ğŸ¤– Build Android APK & AAB
    runs-on: ubuntu-latest
    needs: check-version-update
    if: needs.check-version-update.outputs.should-build == 'true'

    defaults:
      run:
        working-directory: android

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-version-update.outputs.tag }}
          fetch-depth: 0

      - name: ğŸ·ï¸ ë²„ì „ ì •ë³´
        run: |
          echo "ğŸ·ï¸ ë¹Œë“œí•  ë²„ì „: ${{ needs.check-version-update.outputs.tag }}"
          echo "ğŸ“¦ ë²„ì „ ë²ˆí˜¸: ${{ needs.check-version-update.outputs.version }}"

      - name: â˜• JDK ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¤– Android SDK ì„¤ì •
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_API_LEVEL }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS }}

      - name: Android Keystore base64 ë””ì½”ë”©
        env:
          ANDROID_KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          # base64ë¡œ ì¸ì½”ë”©ëœ keystore ë³µì›
          echo "$ANDROID_KEYSTORE_B64" | base64 -d > app/upload-keystore.jks

          # Gradleì—ì„œ ì½ë„ë¡ í™˜ê²½ë³€ìˆ˜ë¡œ ê²½ë¡œ ê¸°ë¡
          echo "KEYSTORE_PATH=$PWD/app/upload-keystore.jks" >> $GITHUB_ENV

      - name: APK & AAB íŒŒì¼ ìƒì„±
        # Gradleì„ í†µí•´ release APK + AAB ë™ì‹œ ìƒì„±
        run: |
          # íƒœê·¸ì—ì„œ ë²„ì „ ë¬¸ìì—´ ì¶”ì¶œ
          VERSION="${{ needs.check-version-update.outputs.version }}"
          
          # ë²„ì „ ë¬¸ìì—´ì„ major/minor/patch ë¶„ë¦¬
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # ë²„ì „ ì½”ë“œë¥¼ ì •ìˆ˜ë¡œ ê³„ì‚° (major * 10000 + minor * 100 + patch)
          VERSION_CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))
          
          echo "ğŸ·ï¸ Version name: $VERSION"
          echo "ğŸ”¢ Version code: $VERSION_CODE"
          
          ./gradlew --no-daemon clean \
            -PappVersionName="$VERSION" \
            -PappVersionCode="$VERSION_CODE" \
            assembleRelease \
            bundleRelease

        env:
          # build.gradleì—ì„œ ì½ëŠ” ì„œëª… ê´€ë ¨ ê°’
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: APK Artifact ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-apk-${{ needs.check-version-update.outputs.version }}
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 90

      - name: AAB Artifact ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-aab-${{ needs.check-version-update.outputs.version }}
          path: android/app/build/outputs/bundle/release/*.aab
          retention-days: 90

      - name: APK, AAB íŒŒì¼ ë¦´ë¦¬ì¦ˆ ì—…ë¡œë“œ
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.check-version-update.outputs.tag }}
        run: |
          echo "ğŸ“¦ GitHub Releaseì— APK/AAB ì—…ë¡œë“œ: $TAG"
          gh release upload "$TAG" \
            app/build/outputs/apk/release/*.apk \
            app/build/outputs/bundle/release/*.aab
