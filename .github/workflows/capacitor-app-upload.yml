name: Capacitor App Upload (TestFlight + Google Play Internal)

on:
  repository_dispatch:
    types: [capacitor-upload]

  workflow_dispatch:
    inputs:
      tag:
        description: 'ì—…ë¡œë“œí•  íƒœê·¸ (ì˜ˆ: v1.2.3)'
        required: true
        type: string

permissions:
  contents: read

concurrency:
  group: capacitor-upload-${{ github.event.client_payload.tag || github.event.inputs.tag }}
  cancel-in-progress: false

env:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # (í”„ë¡œì íŠ¸ë³„ë¡œ ë°”ë€ŒëŠ” ê°’) ìš”ì²­ëŒ€ë¡œ "ì›Œí¬í”Œë¡œ ë‚´ë¶€ì—ì„œ"ë§Œ ì •ì˜
  # ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì— ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ë„ ë™ì‘í•˜ê²Œ í•˜ë ¤ë©´ ì—¬ê¸°ë§Œ ìˆ˜ì •í•˜ë©´ ë¨
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  # Release asset íŒŒì¼ëª… prefix (capacitor-build.ymlì—ì„œ APP_NAMEê³¼ ë™ì¼í•´ì•¼ í•¨)
  ASSET_PREFIX: "AppName"

  # Google Play Console íŒ¨í‚¤ì§€ëª… (applicationId)
  ANDROID_PACKAGE_NAME: "com.example.app"

  # Google Play ì—…ë¡œë“œ íŠ¸ë™: internal / alpha / beta / production
  GOOGLE_PLAY_TRACK: "internal"

  # í‘œì‹œìš© í”„ë¡œì íŠ¸ëª…
  PROJECT_DISPLAY_NAME: "AppName"

  # iOS Bundle ID (ê²€ì¦ìš©)
  IOS_BUNDLE_ID: "com.example.app"

  # fastlane ë²„ì „ ê³ ì • (ì›í•˜ëŠ” ë²„ì „ìœ¼ë¡œ ì¡°ì •)
  FASTLANE_VERSION: "2.219.0" # fastlane ë²„ì „ ê³ ì •(ì•ˆì •ì„±)

jobs:
  resolve_inputs:
    name: Resolve tag/version (payload or manual)
    runs-on: ubuntu-latest

    outputs:
      tag: ${{ steps.resolve.outputs.tag }}
      version: ${{ steps.resolve.outputs.version }}
      release_name: ${{ steps.resolve.outputs.release_name }}

    steps:
      - name: ğŸ§¾ Resolve tag + version
        id: resolve
        shell: bash
        run: |
          set -Eeuo pipefail

          SEMVER_TAG_REGEX='^v(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)$'

          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            TAG="${{ github.event.client_payload.tag }}"
            VERSION="${{ github.event.client_payload.version }}"
          else
            TAG="${{ github.event.inputs.tag }}"
            VERSION="${TAG#v}"
          fi

          if [ -z "$TAG" ] || [[ ! "$TAG" =~ $SEMVER_TAG_REGEX ]]; then
            echo "âŒ Invalid or missing tag: '$TAG' (must be vX.Y.Z)"
            exit 1
          fi

          if [ -z "$VERSION" ]; then
            VERSION="${TAG#v}"
          fi

          PROJECT_NAME="${PROJECT_DISPLAY_NAME:-${{ github.event.repository.name }}}"
          RELEASE_NAME="${PROJECT_NAME} (${VERSION})"

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "release_name=$RELEASE_NAME" >> "$GITHUB_OUTPUT"

          echo "âœ… TAG=$TAG"
          echo "âœ… VERSION=$VERSION"
          echo "âœ… RELEASE_NAME=$RELEASE_NAME"

  upload_android:
    name: Upload Android (AAB) to Google Play Internal
    runs-on: ubuntu-latest
    needs: resolve_inputs

    steps:
      - name: âœ… Validate required config
        shell: bash
        run: |
          set -Eeuo pipefail
          if [ -z "${ANDROID_PACKAGE_NAME}" ] || [ "${ANDROID_PACKAGE_NAME}" = "com.example.waitee" ]; then
            echo "âŒ ANDROID_PACKAGE_NAME must be set to real applicationId"
            exit 1
          fi

      - name: ğŸ“¥ Download AAB from GitHub Release assets
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ needs.resolve_inputs.outputs.tag }}
          VERSION: ${{ needs.resolve_inputs.outputs.version }}
        shell: bash
        run: |
          set -Eeuo pipefail

          AAB_NAME="${ASSET_PREFIX}-${VERSION}.aab"

          echo "Downloading: $AAB_NAME from release $TAG"
          # âœ… CHANGED: repo ëª…ì‹œ (checkout ì—†ì´ gh ì‚¬ìš© ì‹œ ì‹¤íŒ¨ ë°©ì§€)
          gh release download "$TAG" --repo "$GITHUB_REPOSITORY" --pattern "$AAB_NAME" --clobber

          if [ ! -f "$AAB_NAME" ]; then
            echo "âŒ AAB not found after download: $AAB_NAME"
            ls -la || true
            exit 1
          fi

          echo "AAB_PATH=$AAB_NAME" >> "$GITHUB_ENV"
          echo "âœ… Downloaded $AAB_NAME"

      - name: ğŸš€ Upload to Google Play (internal track)
        uses: r0adkll/upload-google-play@v1.1.3
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ env.ANDROID_PACKAGE_NAME }}
          releaseFiles: ${{ env.AAB_PATH }}
          track: ${{ env.GOOGLE_PLAY_TRACK }}
          releaseName: ${{ needs.resolve_inputs.outputs.release_name }}
          status: completed

  upload_ios:
    name: Upload iOS (IPA) to TestFlight
    runs-on: macos-15
    needs: resolve_inputs

    steps:
      - name: âœ… Validate required config
        shell: bash
        run: |
          set -Eeuo pipefail
          if [ -z "${IOS_BUNDLE_ID}" ] || [ "${IOS_BUNDLE_ID}" = "com.example.waitee" ]; then
            echo "âŒ IOS_BUNDLE_ID must be set to real bundle id"
            exit 1
          fi

      - name: ğŸ“¥ Download IPA from GitHub Release assets
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ needs.resolve_inputs.outputs.tag }}
          VERSION: ${{ needs.resolve_inputs.outputs.version }}
        shell: bash
        run: |
          set -Eeuo pipefail

          IPA_NAME="${ASSET_PREFIX}-${VERSION}.ipa"

          echo "Downloading: $IPA_NAME from release $TAG"
          # âœ… CHANGED: repo ëª…ì‹œ (checkout ì—†ì´ gh ì‚¬ìš© ì‹œ ì‹¤íŒ¨ ë°©ì§€)
          gh release download "$TAG" --repo "$GITHUB_REPOSITORY" --pattern "$IPA_NAME" --clobber

          if [ ! -f "$IPA_NAME" ]; then
            echo "âŒ IPA not found after download: $IPA_NAME"
            ls -la || true
            exit 1
          fi

          echo "IPA_PATH=$IPA_NAME" >> "$GITHUB_ENV"
          echo "âœ… Downloaded $IPA_NAME"

      - name: ğŸ’ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"

      - name: ğŸ“¦ Install fastlane (pinned)
        shell: bash
        run: |
          set -Eeuo pipefail
          gem install fastlane -v "${FASTLANE_VERSION}" -N
          fastlane --version

      - name: ğŸ” Create App Store Connect API key files
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_PRIVATE_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY_BASE64 }}
        shell: bash
        run: |
          set -Eeuo pipefail

          if [ -z "$ASC_KEY_ID" ] || [ -z "$ASC_ISSUER_ID" ] || [ -z "$ASC_PRIVATE_KEY_BASE64" ]; then
            echo "âŒ Missing App Store Connect API key secrets"
            echo "   Required: APP_STORE_CONNECT_KEY_ID, APP_STORE_CONNECT_ISSUER_ID, APP_STORE_CONNECT_PRIVATE_KEY_BASE64"
            exit 1
          fi

          KEY_DIR="$RUNNER_TEMP/appstoreconnect"
          mkdir -p "$KEY_DIR"

          P8_PATH="$KEY_DIR/AuthKey_${ASC_KEY_ID}.p8"
          export P8_PATH # pythonì—ì„œ os.environë¡œ ì½ë„ë¡ í™˜ê²½ë³€ìˆ˜ë¡œ export

          # macOS/Linux base64 ì˜µì…˜ ì°¨ì´ ì œê±°ë¥¼ ìœ„í•´ pythonìœ¼ë¡œ ë””ì½”ë”©
          python3 - <<'PY'
          import base64, os
          p8_path = os.environ["P8_PATH"]
          data = os.environ["ASC_PRIVATE_KEY_BASE64"].strip()
          with open(p8_path, "wb") as f:
            f.write(base64.b64decode(data))
          PY

          API_KEY_INFO="$KEY_DIR/api_key_info.json"
          cat > "$API_KEY_INFO" <<EOF
          {
            "key_id": "${ASC_KEY_ID}",
            "issuer_id": "${ASC_ISSUER_ID}",
            "key_filepath": "${P8_PATH}"
          }
          EOF

          echo "ASC_API_KEY_INFO=$API_KEY_INFO" >> "$GITHUB_ENV"
          echo "âœ… App Store Connect API key files ready"

      - name: ğŸš€ Upload to TestFlight (pilot)
        env:
          CHANGELOG: ${{ needs.resolve_inputs.outputs.release_name }}
        shell: bash
        run: |
          set -Eeuo pipefail

          fastlane pilot upload \
            --api_key_path "$ASC_API_KEY_INFO" \
            --ipa "$IPA_PATH" \
            --changelog "$CHANGELOG"
